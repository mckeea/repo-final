name: Release

on:
  push:
    branches:
      - test
      - main

jobs:
  release:
    # if: >
    #   github.event.workflow_run.conclusion == 'success' &&
    #   (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'test')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source (release target)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install release dependencies
        run: |
          npm install --no-save semantic-release \
            @semantic-release/git \
            @semantic-release/changelog \
            @semantic-release/exec \
            @semantic-release/github

      - name: Run Semantic Release
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
        run: |
          BRANCH="${{ github.ref_name }}"
          if [[ "$BRANCH" == "test" ]]; then
            echo "üîÅ Running test (prerelease) release"
            npx semantic-release --tag test
          elif [[ "$BRANCH" == "main" ]]; then
            echo "üöÄ Running official production release"
            npx semantic-release
          else
            echo "‚ùå Invalid branch: $BRANCH"
            exit 1
          fi
